// Prisma 7 schema
// Postgres + "event sourcing lite" activity log.

generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

enum BoardRole {
  OWNER
  EDITOR
  VIEWER
}

enum ActivityEntityType {
  BOARD
  LIST
  CARD
  LABEL
}

model User {
  id        String   @id @default(cuid())
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  memberships     BoardMember[]
  cardAssignments CardAssignee[]
  activityEvents  ActivityEvent[]
}

model Board {
  id        String   @id @default(cuid())
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  lists   List[]
  cards   Card[]
  labels  Label[]
  members BoardMember[]
  events  ActivityEvent[]

  @@index([updatedAt])
}

model BoardMember {
  id        String    @id @default(cuid())
  boardId   String
  userId    String
  role      BoardRole @default(EDITOR)
  createdAt DateTime  @default(now())

  board Board @relation(fields: [boardId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([boardId, userId])
  @@index([userId])
}

model List {
  id        String   @id @default(cuid())
  boardId   String
  title     String
  position  Float
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  board Board  @relation(fields: [boardId], references: [id], onDelete: Cascade)
  cards Card[]

  @@index([boardId, position])
}

model Card {
  id          String    @id @default(cuid())
  boardId     String
  listId      String
  title       String
  description String    @default("")
  dueAt       DateTime?
  position    Float
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  board Board @relation(fields: [boardId], references: [id], onDelete: Cascade)
  list  List  @relation(fields: [listId], references: [id], onDelete: Cascade)

  labels    CardLabel[]
  assignees CardAssignee[]

  @@index([boardId, listId, position])
  @@index([title])
}

model Label {
  id        String   @id @default(cuid())
  boardId   String
  name      String
  color     String
  createdAt DateTime @default(now())

  board Board       @relation(fields: [boardId], references: [id], onDelete: Cascade)
  cards CardLabel[]

  @@unique([boardId, name])
  @@index([boardId])
}

model CardLabel {
  cardId  String
  labelId String

  card  Card  @relation(fields: [cardId], references: [id], onDelete: Cascade)
  label Label @relation(fields: [labelId], references: [id], onDelete: Cascade)

  @@id([cardId, labelId])
  @@index([labelId])
}

model CardAssignee {
  cardId String
  userId String

  card Card @relation(fields: [cardId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([cardId, userId])
  @@index([userId])
}

model ActivityEvent {
  id         String             @id @default(cuid())
  boardId    String
  entityType ActivityEntityType
  entityId   String

  // A short machine type e.g. "card.created", "card.moved", "card.updated"
  type String

  // Optional actor. For now we support both authenticated users and anonymous clients.
  actorUserId   String?
  actorName     String
  actorClientId String

  // Payload always includes "before" and "after" snapshots for undo.
  data Json

  createdAt DateTime @default(now())

  board     Board @relation(fields: [boardId], references: [id], onDelete: Cascade)
  actorUser User? @relation(fields: [actorUserId], references: [id], onDelete: SetNull)

  @@index([boardId, createdAt])
  @@index([entityType, entityId, createdAt])
  @@index([type, createdAt])
}
